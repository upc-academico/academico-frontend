<div class="container-form">
  <mat-card class="form-card">
    <mat-card-header>
      <mat-card-title>
        <mat-icon>{{ edicion ? 'edit' : 'add_circle' }}</mat-icon>
        {{ edicion ? 'Editar Nota' : 'Registrar Nueva Nota' }}
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="aceptar()">
        <!-- Paso 1: Seleccionar Grado y Sección -->
        <div class="form-section">
          <h3>1. Seleccionar Grado y Sección</h3>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Grado</mat-label>
              <mat-select formControlName="grado">
                <mat-option *ngFor="let grado of gradosDocente" [value]="grado">
                  {{grado}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="form.get('grado')?.hasError('required')">
                Seleccione un grado
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Sección</mat-label>
              <mat-select formControlName="seccion" [disabled]="!form.get('grado')?.value">
                <mat-option *ngFor="let seccion of seccionesDocente" [value]="seccion">
                  Sección {{seccion}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="form.get('seccion')?.hasError('required')">
                Seleccione una sección
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Paso 2: Seleccionar Estudiante -->
        <div class="form-section">
          <h3>2. Seleccionar Estudiante</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Estudiante</mat-label>
            <mat-select formControlName="idEstudiante" 
                        [disabled]="!form.get('seccion')?.value">
              <mat-option *ngFor="let estudiante of estudiantesFiltrados" 
                          [value]="estudiante.idEstudiante">
                {{estudiante.apellidos}}, {{estudiante.nombres}}
              </mat-option>
            </mat-select>
            <mat-error *ngIf="form.get('idEstudiante')?.hasError('required')">
              Seleccione un estudiante
            </mat-error>
          </mat-form-field>
        </div>

        <!-- Paso 3: Periodo y Año -->
        <div class="form-section">
          <h3>3. Periodo Académico</h3>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Periodo</mat-label>
              <mat-select formControlName="periodo">
                <mat-option *ngFor="let periodo of periodos" [value]="periodo.value">
                  {{periodo.viewValue}}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Año Académico</mat-label>
              <input matInput type="number" formControlName="anio" min="2020">
            </mat-form-field>
          </div>
        </div>

        <!-- Paso 4: Docente (Pre-cargado) -->
        <div class="form-section">
          <h3>4. Docente</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Docente</mat-label>
            <mat-select formControlName="idDocente">
              <mat-option *ngFor="let docente of listaDocentes" [value]="docente.id">
                {{docente.nombres}} {{docente.apellidos}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Paso 5: Curso y Competencia -->
        <div class="form-section">
          <h3>5. Curso y Competencia</h3>
          <div class="form-row">
            <mat-form-field appearance="outline">
              <mat-label>Curso</mat-label>
              <mat-select formControlName="idCurso">
                <mat-option *ngFor="let curso of listaCursos" [value]="curso.idCurso">
                  {{curso.nombreCurso}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="form.get('idCurso')?.hasError('required')">
                Seleccione un curso
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Competencia</mat-label>
              <mat-select formControlName="idCompetencia" 
                          [disabled]="!form.get('idCurso')?.value">
                <mat-option *ngFor="let competencia of competenciasFiltradas" 
                            [value]="competencia.idCompetencia">
                  {{competencia.nombreCompetencia}}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="form.get('idCompetencia')?.hasError('required')">
                Seleccione una competencia
              </mat-error>
            </mat-form-field>
          </div>
        </div>

        <!-- Paso 6: Calificación -->
        <div class="form-section">
          <h3>6. Calificación</h3>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Calificación</mat-label>
            <mat-select formControlName="calificacion">
              <mat-option *ngFor="let cal of calificaciones" [value]="cal.value">
                <span [style.color]="cal.color">●</span> {{cal.viewValue}}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Observación (Opcional)</mat-label>
            <textarea matInput formControlName="observacion" rows="3" 
                      maxlength="500"></textarea>
            <mat-hint align="end">
              {{form.get('observacion')?.value?.length || 0}}/500
            </mat-hint>
          </mat-form-field>
        </div>

        <!-- Botones de acción -->
        <div class="form-actions">
          <button mat-raised-button type="button" (click)="cancelar()">
            <mat-icon>cancel</mat-icon>
            Cancelar
          </button>
          <button mat-raised-button color="primary" type="submit" 
                  [disabled]="!form.valid || isLoading">
            <mat-icon>{{ edicion ? 'save' : 'add_circle' }}</mat-icon>
            {{ edicion ? 'Actualizar' : 'Registrar' }}
            <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
          </button>
        </div>

        <mat-error *ngIf="mensaje" class="error-message">
          {{mensaje}}
        </mat-error>
      </form>
    </mat-card-content>
  </mat-card>
</div>