<div class="container">
  <mat-card>
    <mat-card-header class="header">
      <mat-card-title>
        <mat-icon>bar_chart</mat-icon>
        Distribución de Calificaciones por Competencia
      </mat-card-title>
      <mat-card-subtitle>
        HU-16: Gráficos de barras que muestren el rendimiento de los estudiantes por competencias
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Formulario de filtros -->
      <form [formGroup]="filterForm" class="filter-form">
        <div class="filter-grid">
          <!-- Curso -->
          <mat-form-field appearance="outline">
            <mat-label>Curso</mat-label>
            <mat-select formControlName="idCurso">
              <mat-option *ngFor="let asignacion of cursosDocente" 
                          [value]="asignacion.idCurso">
                {{asignacion.nombreCurso}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>book</mat-icon>
            <mat-error>Seleccione un curso</mat-error>
          </mat-form-field>

          <!-- Competencia -->
          <mat-form-field appearance="outline">
            <mat-label>Competencia</mat-label>
            <mat-select formControlName="idCompetencia" 
                        [disabled]="!filterForm.get('idCurso')?.value">
              <mat-option *ngFor="let competencia of competenciasCurso" 
                          [value]="competencia.idCompetencia">
                {{competencia.nombreCompetencia}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>stars</mat-icon>
            <mat-error>Seleccione una competencia</mat-error>
          </mat-form-field>

          <!-- Sección -->
          <mat-form-field appearance="outline">
            <mat-label>Sección</mat-label>
            <mat-select formControlName="seccion"
                        [disabled]="!filterForm.get('idCurso')?.value">
              <mat-option *ngFor="let seccion of seccionesDocente" 
                          [value]="seccion">
                Sección {{seccion}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>group</mat-icon>
            <mat-error>Seleccione una sección</mat-error>
          </mat-form-field>

          <!-- Periodo -->
          <mat-form-field appearance="outline">
            <mat-label>Periodo</mat-label>
            <mat-select formControlName="periodo">
              <mat-option *ngFor="let periodo of periodos" 
                          [value]="periodo.value">
                {{periodo.viewValue}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>calendar_today</mat-icon>
          </mat-form-field>

          <!-- Año -->
          <mat-form-field appearance="outline">
            <mat-label>Año Académico</mat-label>
            <input matInput type="number" formControlName="anio" min="2020">
            <mat-icon matPrefix>date_range</mat-icon>
          </mat-form-field>
        </div>

        <!-- Botón de búsqueda -->
        <div class="form-actions">
          <button mat-raised-button color="primary" 
                  (click)="generarGrafico()"
                  [disabled]="!filterForm.valid || isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isLoading">analytics</mat-icon>
            Generar Gráficos
          </button>
        </div>
      </form>

  

      <!-- Resultados -->
      <div class="results-container" *ngIf="distribucionData">
        <!-- Tarjetas de resumen -->
        <div class="summary-grid">
          <mat-card class="summary-card total">
            <div class="summary-content">
              <mat-icon>group</mat-icon>
              <div class="summary-info">
                <span class="summary-label">Total Estudiantes</span>
                <span class="summary-value">{{getTotalEstudiantes()}}</span>
              </div>
            </div>
          </mat-card>

          <mat-card class="summary-card ad">
            <div class="summary-content">
              <mat-icon>star</mat-icon>
              <div class="summary-info">
                <span class="summary-label">AD - Logro Destacado</span>
                <span class="summary-value">
                  {{distribucionData.AD || 0}} 
                  ({{getPorcentaje(distribucionData.AD || 0)}}%)
                </span>
              </div>
            </div>
          </mat-card>

          <mat-card class="summary-card a">
            <div class="summary-content">
              <mat-icon>check_circle</mat-icon>
              <div class="summary-info">
                <span class="summary-label">A - Logro Esperado</span>
                <span class="summary-value">
                  {{distribucionData.A || 0}} 
                  ({{getPorcentaje(distribucionData.A || 0)}}%)
                </span>
              </div>
            </div>
          </mat-card>

          <mat-card class="summary-card b">
            <div class="summary-content">
              <mat-icon>hourglass_empty</mat-icon>
              <div class="summary-info">
                <span class="summary-label">B - En Proceso</span>
                <span class="summary-value">
                  {{distribucionData.B || 0}} 
                  ({{getPorcentaje(distribucionData.B || 0)}}%)
                </span>
              </div>
            </div>
          </mat-card>

          <mat-card class="summary-card c">
            <div class="summary-content">
              <mat-icon>warning</mat-icon>
              <div class="summary-info">
                <span class="summary-label">C - En Inicio</span>
                <span class="summary-value">
                  {{distribucionData.C || 0}} 
                  ({{getPorcentaje(distribucionData.C || 0)}}%)
                </span>
              </div>
            </div>
          </mat-card>
        </div>

        <!-- Gráficos -->
        <div class="charts-grid">
          <div class="chart-card">
            <h3>Gráfico de Barras</h3>
            <div class="chart-wrapper">
              <canvas id="chartBarras"></canvas>
            </div>
          </div>

          <div class="chart-card">
            <h3>Gráfico de Torta</h3>
            <div class="chart-wrapper">
              <canvas id="chartTorta"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje inicial -->
      <div class="initial-message" *ngIf="!distribucionData && !isLoading">
        <mat-icon>bar_chart</mat-icon>
        <p>Seleccione los filtros y haga clic en "Generar Gráficos" para visualizar la distribución de calificaciones</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>