<div class="container">
    <mat-card class="filter-card">
        <mat-card-header>
            <mat-card-title>
                <h2>
                    <mat-icon>show_chart</mat-icon>
                    Evolución del Estudiante por Competencia
                </h2>
                <p class="subtitle">HU-13: Visualice el progreso de cada estudiante en el tiempo</p>
            </mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <form [formGroup]="filterForm">
                <div class="filter-row">
                    <!-- Curso -->
                    <mat-form-field appearance="outline">
                        <mat-label>Curso</mat-label>
                        <mat-select formControlName="idCurso">
                            <mat-option *ngFor="let asignacion of cursosDocente" [value]="asignacion.idCurso">
                                {{ asignacion.nombreCurso }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>book</mat-icon>
                    </mat-form-field>

                    <!-- Competencia -->
                    <mat-form-field appearance="outline">
                        <mat-label>Competencia</mat-label>
                        <mat-select formControlName="idCompetencia" [disabled]="!filterForm.get('idCurso')?.value">
                            <mat-option *ngFor="let competencia of competenciasCurso"
                                [value]="competencia.idCompetencia">
                                {{ competencia.nombreCompetencia }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>stars</mat-icon>
                    </mat-form-field>

                    <!-- Estudiante -->
                    <mat-form-field appearance="outline">
                        <mat-label>Estudiante</mat-label>
                        <mat-select formControlName="idEstudiante" [disabled]="!filterForm.get('idCurso')?.value">
                            <mat-option *ngFor="let estudiante of estudiantesCurso" [value]="estudiante.idEstudiante">
                                {{ estudiante.nombres }} {{ estudiante.apellidos }} - {{ estudiante.grado }} {{
                                estudiante.seccion }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>person</mat-icon>
                    </mat-form-field>

                    <!-- Botón Generar -->
                    <button mat-raised-button color="primary" (click)="generarGrafico()"
                        [disabled]="!filterForm.valid || isLoading" class="search-button">
                        <mat-icon>assessment</mat-icon>
                        Generar Gráfico
                    </button>
                </div>
            </form>
        </mat-card-content>
    </mat-card>

    <!-- Estadísticas -->
    <div class="stats-container" *ngIf="datosEvolucion.length > 0 && !isLoading">
        <mat-card class="stat-card">
            <div class="stat-icon">
                <mat-icon>person</mat-icon>
            </div>
            <div class="stat-content">
                <h4>Estudiante</h4>
                <p>{{ nombreEstudiante }}</p>
            </div>
        </mat-card>

        <mat-card class="stat-card">
            <div class="stat-icon">
                <mat-icon>stars</mat-icon>
            </div>
            <div class="stat-content">
                <h4>Competencia</h4>
                <p>{{ nombreCompetencia }}</p>
            </div>
        </mat-card>

        <mat-card class="stat-card">
            <div class="stat-icon">
                <mat-icon>grade</mat-icon>
            </div>
            <div class="stat-content">
                <h4>Nivel Promedio</h4>
                <p class="calificacion-grande">{{ promedioGeneral }}</p>
            </div>
        </mat-card>

        <mat-card class="stat-card" [class]="getTendenciaClass()">
            <div class="stat-icon">
                <mat-icon>{{ getTendenciaIcon() }}</mat-icon>
            </div>
            <div class="stat-content">
                <h4>Tendencia</h4>
                <p>{{ tendencia === 'mejora' ? 'Mejorando' : tendencia === 'retroceso' ? 'Retrocediendo' : 'Estable' }}
                </p>
            </div>
        </mat-card>
    </div>

    <!-- Gráfico -->
    <mat-card class="chart-card" *ngIf="datosEvolucion.length > 0 && !isLoading">
        <mat-card-content>
            <div class="chart-wrapper">
                <canvas id="chartEvolucion"></canvas>
            </div>

            <!-- Leyenda de colores -->
            <div class="legend">
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #4caf50;"></span>
                    <span>AD - Logro Destacado</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #2196f3;"></span>
                    <span>A - Logro Esperado</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #ff9800;"></span>
                    <span>B - En Proceso</span>
                </div>
                <div class="legend-item">
                    <span class="legend-color" style="background-color: #f44336;"></span>
                    <span>C - En Inicio</span>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Tabla de historial -->
    <mat-card class="history-card" *ngIf="datosEvolucion.length > 0 && !isLoading">
        <mat-card-header class="history-header">
            <mat-card-title>
                <h3>
                    <mat-icon>history</mat-icon>
                    Historial de Calificaciones
                </h3>
            </mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <div class="history-timeline">
                <div class="timeline-item" *ngFor="let nota of datosEvolucion">
                    <div class="timeline-marker" [style.background-color]="getColorPorCalificacion(nota.calificacion)">
                        <span>{{ nota.calificacion }}</span>
                    </div>
                    <div class="timeline-content">
                        <h4>{{ nota.periodo }} {{ nota.anio }}</h4>
                        <p class="estado">{{ nota.estadoAcademico }}</p>
                        <p class="observacion" *ngIf="nota.observacion">
                            <mat-icon>comment</mat-icon>
                            {{ nota.observacion }}
                        </p>
                    </div>
                </div>
            </div>
        </mat-card-content>
    </mat-card>

    <!-- Loading -->
    <div class="loading-container" *ngIf="isLoading">
        <mat-spinner></mat-spinner>
        <p>Cargando evolución del estudiante...</p>
    </div>

    <!-- Sin datos -->
    <mat-card class="no-data-card" *ngIf="datosEvolucion.length === 0 && !isLoading && filterForm.valid">
        <div class="no-data-content">
            <mat-icon>info</mat-icon>
            <p>No hay registros de calificaciones para este estudiante en esta competencia</p>
        </div>
    </mat-card>
</div>