<div class="container">
  <mat-card>
    <mat-card-header class="header">
      <mat-card-title>
        <mat-icon>show_chart</mat-icon>
        Evolución del Estudiante por Competencia
      </mat-card-title>
      <mat-card-subtitle>
        HU-13: Gráficos de evolución del progreso de cada estudiante en el tiempo
      </mat-card-subtitle>
    </mat-card-header>

    <mat-card-content>
      <!-- Formulario de filtros -->
      <form [formGroup]="filterForm" class="filter-form">
        <div class="filter-grid">
          <!-- Curso -->
          <mat-form-field appearance="outline">
            <mat-label>Curso</mat-label>
            <mat-select formControlName="idCurso">
              <mat-option *ngFor="let asignacion of cursosDocente" 
                          [value]="asignacion.idCurso">
                {{asignacion.nombreCurso}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>book</mat-icon>
            <mat-error>Seleccione un curso</mat-error>
          </mat-form-field>

          <!-- Competencia -->
          <mat-form-field appearance="outline">
            <mat-label>Competencia</mat-label>
            <mat-select formControlName="idCompetencia" 
                        [disabled]="!filterForm.get('idCurso')?.value">
              <mat-option *ngFor="let competencia of competenciasCurso" 
                          [value]="competencia.idCompetencia">
                {{competencia.nombreCompetencia}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>stars</mat-icon>
            <mat-error>Seleccione una competencia</mat-error>
          </mat-form-field>

          <!-- Estudiante -->
          <mat-form-field appearance="outline">
            <mat-label>Estudiante</mat-label>
            <mat-select formControlName="idEstudiante"
                        [disabled]="!filterForm.get('idCurso')?.value">
              <mat-option *ngFor="let estudiante of estudiantesCurso" 
                          [value]="estudiante.idEstudiante">
                {{estudiante.apellidos}}, {{estudiante.nombres}}
              </mat-option>
            </mat-select>
            <mat-icon matPrefix>person</mat-icon>
            <mat-error>Seleccione un estudiante</mat-error>
          </mat-form-field>
        </div>

        <!-- Botón de búsqueda -->
        <div class="form-actions">
          <button mat-raised-button color="primary" 
                  (click)="generarGrafico()"
                  [disabled]="!filterForm.valid || isLoading">
            <mat-spinner *ngIf="isLoading" diameter="20"></mat-spinner>
            <mat-icon *ngIf="!isLoading">analytics</mat-icon>
            Generar Gráfico
          </button>
        </div>
      </form>

   

      <!-- Estadísticas y gráfico -->
      <div class="results-container" *ngIf="datosEvolucion.length > 0">
        <!-- Tarjetas de estadísticas -->
        <div class="stats-grid">
          <mat-card class="stat-card">
            <div class="stat-content">
              <mat-icon class="stat-icon promedio">assessment</mat-icon>
              <div class="stat-info">
                <span class="stat-label">Promedio General</span>
                <span class="stat-value">{{promedioGeneral}}</span>
              </div>
            </div>
          </mat-card>

          <mat-card class="stat-card">
            <div class="stat-content">
              <mat-icon class="stat-icon" [ngClass]="getTendenciaClass()">
                {{getTendenciaIcon()}}
              </mat-icon>
              <div class="stat-info">
                <span class="stat-label">Tendencia</span>
                <span class="stat-value">
                  {{tendencia === 'mejora' ? 'Mejorando' : 
                    tendencia === 'retroceso' ? 'En Retroceso' : 'Estable'}}
                </span>
              </div>
            </div>
          </mat-card>

          <mat-card class="stat-card">
            <div class="stat-content">
              <mat-icon class="stat-icon registros">calendar_today</mat-icon>
              <div class="stat-info">
                <span class="stat-label">Registros</span>
                <span class="stat-value">{{datosEvolucion.length}}</span>
              </div>
            </div>
          </mat-card>
        </div>

        <!-- Información del estudiante y competencia -->
        <div class="info-banner">
          <div class="info-item">
            <mat-icon>person</mat-icon>
            <div>
              <span class="info-label">Estudiante:</span>
              <span class="info-value">{{nombreEstudiante}}</span>
            </div>
          </div>
          <div class="info-item">
            <mat-icon>stars</mat-icon>
            <div>
              <span class="info-label">Competencia:</span>
              <span class="info-value">{{nombreCompetencia}}</span>
            </div>
          </div>
        </div>

        <!-- Gráfico -->
        <div class="chart-container">
          <canvas id="chartEvolucion"></canvas>
        </div>

        <!-- Leyenda de calificaciones -->
        <div class="legend-container">
          <h4>Escala de Calificaciones:</h4>
          <div class="legend-grid">
            <div class="legend-item">
              <span class="legend-color" style="background: #4caf50;"></span>
              <span>AD - Logro Destacado</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background: #2196f3;"></span>
              <span>A - Logro Esperado</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background: #ff9800;"></span>
              <span>B - En Proceso</span>
            </div>
            <div class="legend-item">
              <span class="legend-color" style="background: #f44336;"></span>
              <span>C - En Inicio</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Mensaje inicial -->
      <div class="initial-message" *ngIf="datosEvolucion.length === 0 && !isLoading">
        <mat-icon>show_chart</mat-icon>
        <p>Seleccione un curso, competencia y estudiante para visualizar su evolución</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>