<div class="container">
    <mat-card class="filter-card">
        <mat-card-header>
            <mat-card-title>
                <h2>
                    <mat-icon>filter_list</mat-icon>
                    Filtrar Notas por Curso y Competencia
                </h2>
                <p class="subtitle">HU-15: Personalice la información según su área y competencia</p>
            </mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <form [formGroup]="filterForm">
                <div class="filter-row">
                    <!-- Curso -->
                    <mat-form-field appearance="outline">
                        <mat-label>Curso</mat-label>
                        <mat-select formControlName="idCurso">
                            <mat-option *ngFor="let asignacion of cursosDocente" [value]="asignacion.idCurso">
                                {{ asignacion.nombreCurso }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>book</mat-icon>
                    </mat-form-field>

                    <!-- Competencia -->
                    <mat-form-field appearance="outline">
                        <mat-label>Competencia</mat-label>
                        <mat-select formControlName="idCompetencia" [disabled]="!filterForm.get('idCurso')?.value">
                            <mat-option *ngFor="let competencia of competenciasCurso"
                                [value]="competencia.idCompetencia">
                                {{ competencia.nombreCompetencia }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>stars</mat-icon>
                    </mat-form-field>

                    <!-- Sección -->
                    <mat-form-field appearance="outline">
                        <mat-label>Sección</mat-label>
                        <mat-select formControlName="seccion" [disabled]="!filterForm.get('idCurso')?.value">
                            <mat-option *ngFor="let seccion of seccionesDocente" [value]="seccion">
                                Sección {{ seccion }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>class</mat-icon>
                    </mat-form-field>
                </div>

                <div class="filter-row">
                    <!-- Periodo -->
                    <mat-form-field appearance="outline">
                        <mat-label>Periodo</mat-label>
                        <mat-select formControlName="periodo">
                            <mat-option *ngFor="let periodo of periodos" [value]="periodo.value">
                                {{ periodo.viewValue }}
                            </mat-option>
                        </mat-select>
                        <mat-icon matPrefix>calendar_today</mat-icon>
                    </mat-form-field>

                    <!-- Año -->
                    <mat-form-field appearance="outline">
                        <mat-label>Año Académico</mat-label>
                        <input matInput type="number" formControlName="anio">
                        <mat-icon matPrefix>event</mat-icon>
                    </mat-form-field>

                    <!-- Botón Buscar -->
                    <button mat-raised-button color="primary" (click)="buscarNotas()"
                        [disabled]="!filterForm.valid || isLoading" class="search-button">
                        <mat-icon>search</mat-icon>
                        Buscar
                    </button>
                </div>
            </form>
        </mat-card-content>
    </mat-card>

    <!-- Resultados -->
    <mat-card class="results-card" *ngIf="dataSource.data.length > 0 || isLoading">
        <mat-card-header class="results-header">
            <mat-card-title>
                <h3>
                    <mat-icon>list</mat-icon>
                    Resultados ({{ dataSource.data.length }} estudiante(s))
                </h3>
            </mat-card-title>
        </mat-card-header>

        <mat-card-content>
            <div class="loading-container" *ngIf="isLoading">
                <mat-spinner></mat-spinner>
                <p>Cargando notas...</p>
            </div>

            <div class="table-container" *ngIf="!isLoading">
                <table mat-table [dataSource]="dataSource" class="mat-elevation-z2">

                    <!-- Columna Estudiante -->
                    <ng-container matColumnDef="estudiante">
                        <th mat-header-cell *matHeaderCellDef>Estudiante</th>
                        <td mat-cell *matCellDef="let nota">
                            <div class="student-cell">
                                <mat-icon>person</mat-icon>
                                <span>{{ nota.nombreEstudiante }}</span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Columna Competencia -->
                    <ng-container matColumnDef="competencia">
                        <th mat-header-cell *matHeaderCellDef>Competencia</th>
                        <td mat-cell *matCellDef="let nota">
                            <div class="competencia-cell">
                                <mat-icon>stars</mat-icon>
                                <span>{{ nota.nombreCompetencia }}</span>
                            </div>
                        </td>
                    </ng-container>

                    <!-- Columna Calificación -->
                    <ng-container matColumnDef="calificacion">
                        <th mat-header-cell *matHeaderCellDef>Calificación</th>
                        <td mat-cell *matCellDef="let nota">
                            <mat-chip [class]="getCalificacionClass(nota.calificacion)">
                                {{ nota.calificacion }} - {{ nota.estadoAcademico }}
                            </mat-chip>
                        </td>
                    </ng-container>

                    <!-- Columna Observación -->
                    <ng-container matColumnDef="observacion">
                        <th mat-header-cell *matHeaderCellDef>Observación</th>
                        <td mat-cell *matCellDef="let nota">
                            <span class="observacion">{{ nota.observacion || 'Sin observación' }}</span>
                        </td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
            </div>
        </mat-card-content>
    </mat-card>
</div>